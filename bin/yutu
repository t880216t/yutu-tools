#!/usr/bin/env node

var fs = require('fs');
var path = require('path');
var program = require('commander');
var Yutu = require('../');

var pkg = require('../package.json');

// æ§åˆ¶æ—¥å¿—æ ¼å¼åŒ–æ‰“å°
var rawStdoutWrite = process.stdout.write;
fs.writeFileSync('yutu.log', '')
process.stdout.write = function(string, encoding, fileDescriptor) {
    var nocolor = string.replace(/(\[\d+[mdc]|\[K)/gi, '');
    fs.appendFileSync('yutu.log', nocolor)
    rawStdoutWrite.apply(process.stdout, arguments);
}

console.log(("Yutu "+pkg.version).green);
console.log('');
console.log('------------------------------------------------------------------\n'.green);

// å‘½ä»¤æ”¯æŒçš„å‚æ•°
program
    .version(pkg.version)
    .option('--no-color', 'æ§åˆ¶å°ä¸æ˜¾ç¤ºé¢œè‰²')
    .option('-d --debug', 'debugæ¨¡å¼')
    .option('-r --raw', 'ä¿å­˜å…¨éƒ¨å‘½ä»¤')
    .option('--main_client [value]', 'ä¸»æ§æµè§ˆå™¨ä¿¡æ¯,ä¾‹ï¼šchrome:106')
    .option('--sync [value]', 'åŒæ­¥æµè§ˆå™¨åˆ—è¡¨,ä¾‹ï¼šchrome:100,firefox:104,internet_explorer:11')
    .option('--hub_host [value]', 'è¿œç¨‹æµè§ˆå™¨æœåŠ¡å™¨åœ°å€')
    .option('--hub_port [value]', 'è¿œç¨‹æµè§ˆå™¨æœåŠ¡å™¨ç«¯å£')
    .option('--server_ip [value]', 'åŒæ­¥æ§åˆ¶è®¾å¤‡çš„ipï¼ˆä½¿ç”¨è¿œç¨‹æµè§ˆå™¨æ—¶éœ€è¦ï¼Œé»˜è®¤ä¸ºæœ¬åœ°127.0.0.1ï¼‰')
    .option('--browser_size [value]', 'çª—å£å¤§å°ï¼Œé»˜è®¤1024x768')
    .option('--http_proxy [value]', 'è¿œç¨‹æµè§ˆå™¨httpä»£ç†')
    .option('--default_url [value]', 'é»˜è®¤èµ·å§‹åœ°å€')

let cmd = null;

program.command('init')
    .description('Init Yutu config file')
    .action(function(){
        cmd = 'init';
        Yutu.init();
    });

program.command('start')
    .description('Start recorder')
    .action(function(){
        cmd = 'start'
        Yutu.start({
            debug: program.debug,
            raw: program.raw,
            browserSize: program.browser_size,
            httpProxy: program.http_proxy,
            defaultUrl: program.default_url,
        });
    });

program.parse(process.argv);
Yutu.checkUpdate();

if(cmd === null){
    var rootPath = getRootPath();
    var configPath = 'config.json';
    var configFile = path.resolve(rootPath + '/' + configPath);

    if(fs.existsSync(configFile)){
        Yutu.start({
            debug: program.debug,
            raw: program.raw,
            browserSize: program.browser_size,
            httpProxy: program.http_proxy,
            defaultUrl: program.default_url,
        });
    }else {
        console.log(configPath.bold+' '+__('file_missed').red);
        console.log('');
        Yutu.init();
    }
}
function getRootPath(){
    var rootPath = path.resolve('.');
    while(rootPath){
        if(fs.existsSync(rootPath + '/config.json')){
            break;
        }
        rootPath = rootPath.substring(0, rootPath.lastIndexOf(path.sep));
    }
    return rootPath;
}
